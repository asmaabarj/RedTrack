<div class="h-screen flex flex-col overflow-hidden bg-slate-50">
  <app-navbar class="flex-shrink-0 shadow-sm bg-white border-b border-slate-200"></app-navbar>
  
  <div class="flex-1 bg-gradient-to-br from-slate-50 via-indigo-50/5 to-slate-100 overflow-hidden">
    <div class="h-full max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Loading Spinner -->
      <div *ngIf="loading$ | async" class="flex justify-center my-8">
        <div class="animate-spin rounded-full h-8 w-8 border-2 border-red-600 border-t-transparent"></div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error$ | async as error" class="text-red-600 mb-4">
        {{ error }}
      </div>

      <!-- Main Content -->
      <div class="h-full flex">
        <!-- Etapes List -->
        <div class="w-96 bg-white rounded-l-xl shadow-sm ring-1 ring-black/5 flex flex-col overflow-hidden backdrop-blur-xl">
          <div class="flex-shrink-0 p-5 border-b border-slate-100">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-3">
              <div class="px-1 bg-indigo-50 rounded-lg">
                <i class="fas fa-tasks text-red-700 text-sm"></i>
              </div>
              Étapes du fil rouge
            </h2>
            <p class="text-sm text-slate-500 mt-2">Progression de l'apprenant</p>
          </div>
          
          <div class="flex-1 overflow-y-auto">
            <div *ngIf="loading$ | async" class="flex justify-center p-8">
              <div class="animate-spin rounded-full h-8 w-8 border-2 border-slate-600 border-t-transparent"></div>
            </div>

            <div *ngFor="let etape of etapes$ | async" 
                 (click)="selectEtape(etape)"
                 [class]="'cursor-pointer border-l-4 transition-all duration-300 ' + 
                          (selectedEtape?.id === etape.id ? 
                          'bg-indigo-50/70 border-red-700 shadow-sm' : 
                          'border-transparent hover:bg-slate-50')"
            >
              <div class="p-4">
                <h3 class="font-medium text-slate-800 flex items-center text-md">
                  {{ etape.titre }}
                </h3>
                <div class="flex items-center gap-3 mt-1 text-sm text-slate-500">
                  <div class="flex items-center gap-1">
                    <i class="far fa-calendar text-red-700 text-xs"></i>
                    <span>{{ etape.deadline | date:'dd MMM yyyy' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Rendus Area -->
        <div class="flex-1 flex flex-col bg-white rounded-r-xl shadow-sm ring-1 ring-black/5 overflow-hidden backdrop-blur-xl">
          <!-- Header -->
          <div class="flex-shrink-0 p-5 border-b border-slate-100 bg-gradient-to-r from-white to-slate-50">
            <div class="flex items-center justify-between">
              <div>
                <div class="flex items-center gap-3">
                  <h1 class="text-xl font-semibold text-slate-800">
                    {{ selectedEtape?.titre || 'Sélectionnez une étape' }}
                  </h1>
                  <!-- Affichage du type du dernier rendu -->
                  <span *ngIf="selectedEtape?.rendus?.length && getLastRendu(selectedEtape?.rendus!)?.type" 
                        [class]="'px-2.5 py-1 rounded-full text-xs ' + getStatusClass(getLastRendu(selectedEtape?.rendus!)?.type!)">
                    {{ getStatusLabel(getLastRendu(selectedEtape?.rendus!)?.type!) }}
                  </span>
                </div>
                <p class="text-sm text-slate-500 mt-2">Consultez et répondez aux rendus de l'apprenant</p>
              </div>
            </div>
          </div>

          <!-- Rendus Area -->
          <div class="flex-1 overflow-y-auto">
            <div class="p-8 space-y-10">
              <!-- Empty State -->
              <div *ngIf="selectedEtape && (!selectedEtape.rendus || selectedEtape.rendus.length === 0)" 
                   class="flex flex-col items-center justify-center py-12">
                <div class="rounded-full bg-slate-100 p-4 mb-4">
                  <i class="fas fa-file-alt text-slate-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-800 mb-2">
                  Aucun rendu pour cette étape
                </h3>
                <p class="text-sm text-slate-500 text-center max-w-sm">
                  L'apprenant n'a pas encore soumis de rendu pour cette étape.
                </p>
              </div>

              <!-- Rendus List -->
              <div *ngFor="let rendu of selectedEtape?.rendus; let last = last" class="space-y-6">
                <!-- Rendu Message -->
                <div class="flex gap-2">
                  <div class="h-8 w-8 rounded-full bg-gray-500 flex-shrink-0 flex items-center justify-center border-2 border-gray-200">
                    <span class="text-white text-sm">{{ getInitials(rendu.apprenantPrenom) }}{{ getInitials(rendu.apprenantNom) }}</span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-3">
                      <span class="font-medium text-slate-800 text-md">{{ rendu.apprenantNom }} {{ rendu.apprenantPrenom }}</span>
                      <span class="text-slate-300">•</span>
                    </div>
                    <div class="bg-slate-100/60 rounded-2xl text-sm p-6 border border-slate-100 shadow-sm">
                      <p class="text-slate-700 leading-relaxed">{{ rendu.commentaire }}</p>
                      <div *ngIf="rendu.livrable" class="mt-4 pt-4 border-t border-slate-200">
                        <a [href]="rendu.livrable" class="inline-flex items-center gap-3 px-4 py-2 text-indigo-600 rounded-lg transition-colors group">
                          <i class="fas fa-paperclip text-xs transition-transform group-hover:rotate-12"></i>
                          {{ rendu.livrable }}
                        </a>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Responses -->
                <div class="ml-20 space-y-4">
                  <div *ngFor="let response of rendu.responses" class="mt-4">
                    <div class="flex gap-2">
                      <div class="h-8 w-8 rounded-full bg-gray-100 flex-shrink-0 flex items-center justify-center border-2 border-gray-200">
                        <span class="text-slate-700 text-sm">{{ getInitials(response.formateurNom) }}{{ getInitials(response.formateurPrenom) }}</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-2">
                          <span class="font-medium text-slate-800">{{ response.formateurNom }} {{ response.formateurPrenom }}</span>
                          <span class="text-slate-300">•</span>
                          <span class="text-sm text-blue-800 font-medium">Formateur</span>
                        </div>
                        <div class="bg-indigo-50/40 rounded-xl p-5 border border-indigo-100/50 shadow-sm">
                          <p class="text-slate-700 leading-relaxed">{{ response.commentaire }}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Bouton Répondre après les réponses du dernier rendu -->
                  <div *ngIf="last" class="mt-6 flex justify-end">
                    <button 
                      (click)="onSubmitResponse(rendu)"
                      class="inline-flex items-center justify-center mt-2 gap-2 px-4 py-2
                             bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 
                             text-white rounded-full
                             transition-all duration-300 text-xs shadow-sm transform hover:-translate-y-0.5"
                    >
                      <i class="fas fa-reply"></i>
                      <span>Répondre</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showResponseModal && selectedRendu" 
     class="fixed inset-0 z-50 overflow-y-auto bg-slate-900/80 backdrop-blur-sm transition-all duration-300"
     (click)="onCloseModal()">
  <div class="min-h-screen px-4 text-center flex items-center justify-center">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl ring-1 ring-black/5"
         (click)="$event.stopPropagation()">
      <app-create-reponse-rendu 
        [rendu]="selectedRendu"
        (closeModal)="onCloseModal()"
        (responseCreated)="onRenduResponseCreated()"
      ></app-create-reponse-rendu>
    </div>
  </div>
</div>
